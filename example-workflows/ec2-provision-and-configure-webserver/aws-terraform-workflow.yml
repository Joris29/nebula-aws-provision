version: v1
description: Nebula Deploy Demo To AWS

parameters:
  backend_key:
    description: The key for the S3 backend key
    default: nebula
  shared_credentials_file:
    description: The location of the shared credentials file
    default: /workspace/credentials
  aws_region:
    description: The AWS region to deploy S3 bucket + EC2 instance
    default: eu-west-1
  vpc_id:
    description: The AWS vpc id to deploy EC2 instance
  terraform_state_bucket:
    description: The name of the bucket you'd like to store terraform state in
    default: terraform-remote-jva-nebula

steps:
- name: provision-s3-remote-state-bucket
  image: projectnebula/core
  input:
    - apk --no-cache add python3 curl &&
      curl -O https://bootstrap.pypa.io/get-pip.py &&
      python3 get-pip.py &&
      pip3 install awscli --upgrade &&
      BUCKET_REGION=$(ni get -p {.region}) &&
      BUCKET_NAME=$(ni get -p {.bucket}) &&
      ni get -p {.credentials} &&
      ni credentials config &&
      export AWS_CONFIG_FILE=/workspace/credentials &&
      if aws s3api list-buckets --query "Buckets[].Name" | grep $BUCKET_NAME; then exit 0; else aws s3api create-bucket --bucket $BUCKET_NAME --region $BUCKET_REGION --create-bucket-configuration LocationConstraint=$BUCKET_REGION && exit 0; fi
  spec:
    region:
      $type: Parameter
      name: aws_region
    bucket: 
      $type: Parameter
      name: terraform_state_bucket
    credentials:
      credentials:
        $type: Secret
        name: credentials

- name: provision-ec2-with-terraform
  dependsOn:
    - provision-s3-remote-state-bucket
  image: projectnebula/terraform
  spec:
    backendConfig:
      bucket: 
        $type: Parameter
        name: terraform_state_bucket
      key:
        $type: Parameter
        name: backend_key
      region: 
        $type: Parameter
        name: aws_region
      shared_credentials_file:
        $type: Parameter
        name: shared_credentials_file
    vars:
      vpc_id: 
        $type: Parameter
        name: vpc_id
      aws_region:
        $type: Parameter
        name: aws_region
    workspace: production
    directory: example-workflows/ec2-provision-and-configure-webserver/infra/
    credentials:
      credentials:
        $type: Secret
        name: credentials
    git:
      name: aws-workflow-example
      repository: https://github.com/Joris29/nebula-aws-provision.git